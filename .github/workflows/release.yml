name: Release (RPM Fedora + RHEL 10)

on:
  push:
    branches:
      - main
    paths:
      - VERSION
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  source:
    name: Prepare source tarball
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
      rpm_version: ${{ steps.ver.outputs.rpm_version }}
      tag: ${{ steps.ver.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f VERSION ]; then
            echo "VERSION file not found" >&2
            exit 1
          fi
          VERSION="$(tr -d '\r\n' < VERSION)"
          if [ -z "${VERSION}" ]; then
            echo "VERSION is empty" >&2
            exit 1
          fi
          TAG="v${VERSION}"

          # RPM Version cannot contain '-' so map prerelease separators to '~'
          RPM_VERSION="${VERSION//-/~}"
          # '+' is common in semver build metadata; map to '.' for RPM compatibility
          RPM_VERSION="${RPM_VERSION//+/.}"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "rpm_version=${RPM_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Create source tarball
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.ver.outputs.rpm_version }}"
          mkdir -p dist
          git archive --format=tar.gz --prefix="aiconnect-${VERSION}/" -o "dist/aiconnect-${VERSION}.tar.gz" "${GITHUB_SHA}"

      - name: Upload source artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          if-no-files-found: error
          path: dist/aiconnect-*.tar.gz

  rpm:
    name: Build RPM (${{ matrix.distro }})
    runs-on: ubuntu-latest
    needs: source
    strategy:
      fail-fast: false
      matrix:
        distro: [fedora, rhel10]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download source tarball
        uses: actions/download-artifact@v4
        with:
          name: source-tarball
          path: dist

      - name: Build RPM in container
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ needs.source.outputs.rpm_version }}"
          SPEC_PATH="packaging/rpm/aiconnect.spec"
          SRC_TARBALL="dist/aiconnect-${VERSION}.tar.gz"

          if [ "${{ matrix.distro }}" = "fedora" ]; then
            IMAGE="fedora:latest"
          else
            IMAGE="registry.access.redhat.com/ubi10/ubi"
          fi

          docker run --rm -t \
            -v "${PWD}:/ws" \
            -w /ws \
            "${IMAGE}" \
            bash -lc "\
              set -euo pipefail;\
              if command -v microdnf >/dev/null 2>&1; then\
                microdnf -y install rpm-build golang git shadow-utils;\
              elif command -v dnf >/dev/null 2>&1; then\
                dnf -y install rpm-build golang git shadow-utils;\
              elif command -v yum >/dev/null 2>&1; then\
                yum -y install rpm-build golang git shadow-utils;\
              else\
                echo 'No supported package manager found (microdnf/dnf/yum)' >&2;\
                exit 1;\
              fi;\
              TOPDIR=\"/tmp/rpmbuild\";\
              mkdir -p \"\$TOPDIR\"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS};\
              cp -a \"${SRC_TARBALL}\" \"\$TOPDIR/SOURCES/aiconnect-${VERSION}.tar.gz\";\
              cp -a \"${SPEC_PATH}\" \"\$TOPDIR/SPECS/aiconnect.spec\";\
              rpmbuild -ba \"\$TOPDIR/SPECS/aiconnect.spec\" \
                --define \"_topdir \$TOPDIR\" \
                --define \"tagver ${VERSION}\";\
              mkdir -p /ws/dist/${{ matrix.distro }};\
              find \"\$TOPDIR/RPMS\" -type f -name '*.rpm' -exec cp -a {} /ws/dist/${{ matrix.distro }}/ \;;\
              find \"\$TOPDIR/SRPMS\" -type f -name '*.src.rpm' -exec cp -a {} /ws/dist/${{ matrix.distro }}/ \;;\
            "

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-${{ matrix.distro }}
          if-no-files-found: error
          path: dist/${{ matrix.distro }}/*.rpm

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [source, rpm]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Generate checksums
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          sha256sum *.rpm *.tar.gz 2>/dev/null > SHA256SUMS.txt || true

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.source.outputs.tag }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: |
            dist/**/*.rpm
            dist/**/*.tar.gz
            dist/SHA256SUMS.txt

  copr:
    name: Submit build to COPR
    runs-on: ubuntu-latest
    needs: [source, rpm]
    if: ${{ secrets.COPR_CONFIG != '' }}
    container:
      image: fedora:latest
    steps:
      - name: Download SRPM artifact (from Fedora build)
        uses: actions/download-artifact@v4
        with:
          name: rpm-fedora
          path: dist

      - name: Install copr-cli
        shell: bash
        run: |
          set -euo pipefail
          dnf -y install copr-cli

      - name: Configure COPR credentials
        shell: bash
        env:
          COPR_CONFIG: ${{ secrets['COPR_CONFIG'] }}
        run: |
          set -euo pipefail
          if [ -z "${COPR_CONFIG:-}" ]; then
            echo "Missing required secret COPR_CONFIG (content of ~/.config/copr)." >&2
            exit 1
          fi
          mkdir -p ~/.config
          umask 077
          printf '%s' "$COPR_CONFIG" > ~/.config/copr

      - name: Submit SRPM to COPR
        shell: bash
        run: |
          set -euo pipefail
          PROJECT="frzzzzz19/AIConnect"

          SRPM="$(ls -1 dist/*.src.rpm | head -n 1)"
          if [ -z "${SRPM}" ] || [ ! -f "${SRPM}" ]; then
            echo "SRPM not found in dist/" >&2
            ls -la dist || true
            exit 1
          fi

          copr-cli build --nowait "${PROJECT}" "${SRPM}"
